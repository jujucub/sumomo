# sumomo - 設計書

> GitHub Issue / Slack 連携 Claude 自動対応システム

## 概要

GitHub Issue や Slack メンションをトリガーに、ローカル環境の Claude CLI が自動でコード修正・PR作成を行うシステム。

**名前の由来**: CLAMPの漫画「ちょびっツ」に登場するモバイルパソコン「すもも」から。小さいけど一生懸命働くイメージ。

---

## システム構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              Slack                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │
│  │ @sumomo 指示    │  │ 承認ボタン      │  │ sumomoからの質問        │ │
│  │ 「このバグ直して」│  │ [許可] [拒否]   │  │ 「AとBどちらにする？」   │ │
│  └────────┬────────┘  └────────┬────────┘  └────────────┬────────────┘ │
└───────────┼────────────────────┼────────────────────────┼───────────────┘
            │                    │                        │
            │ Socket Mode        │                        │
            ▼                    ▼                        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ローカルPC - sumomo Bot                                                │
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                                                                    ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ ││
│  │  │ Slack Bot    │  │ GitHub監視   │  │ 承認サーバー             │ ││
│  │  │ Socket Mode  │  │ ポーリング   │  │ Express (port:3001)      │ ││
│  │  └──────┬───────┘  └──────┬───────┘  └────────────┬─────────────┘ ││
│  │         │                 │                       │               ││
│  │         └─────────────────┼───────────────────────┘               ││
│  │                           ▼                                       ││
│  │                  ┌─────────────────┐                              ││
│  │                  │  タスクキュー   │                              ││
│  │                  └────────┬────────┘                              ││
│  │                           │                                       ││
│  └───────────────────────────┼────────────────────────────────────────┘│
│                              │                                         │
│                              ▼                                         │
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │  Claude CLI                                                        ││
│  │  ┌──────────────────────────────────────────────────────────────┐ ││
│  │  │ PreToolUse Hook                                              │ ││
│  │  │ - 危険なコマンド → Slack承認                                  │ ││
│  │  │ - 許可されたら実行                                           │ ││
│  │  └──────────────────────────────────────────────────────────────┘ ││
│  │  ┌──────────────────────────────────────────────────────────────┐ ││
│  │  │ MCP: ask-human                                               │ ││
│  │  │ - 判断が必要な時 → Slackで質問                               │ ││
│  │  │ - 回答を受けて続行                                           │ ││
│  │  └──────────────────────────────────────────────────────────────┘ ││
│  └────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
            │
            │ 処理完了
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  GitHub                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ PR作成、Issueコメント                                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 機能一覧

| 機能 | トリガー | 動作 |
|------|---------|------|
| **Issue自動対応** | GitHub Issue に `@sumomo` | Issue内容を読み取り、コード修正、PR作成 |
| **Slack指示** | Slack で `@sumomo` | 指示に従ってタスク実行 |
| **実行承認** | 危険なコマンド実行時 | Slackで許可/拒否ボタン表示 |
| **質問回答** | sumomoが判断を求める時 | Slackで選択肢または自由入力 |
| **進捗通知** | 処理開始・完了時 | Slackスレッドで状況報告 |

---

## コンポーネント詳細

### 1. 統合Bot (メインプロセス)

```
src/
├── index.ts          # エントリーポイント
├── slack/
│   ├── bot.ts        # Slack Bot (Socket Mode)
│   └── handlers.ts   # メンション・ボタン処理
├── github/
│   └── poller.ts     # Issue監視 (5分間隔)
├── approval/
│   └── server.ts     # 承認サーバー (Express)
├── claude/
│   └── runner.ts     # Claude CLI 実行
└── queue/
    └── taskQueue.ts  # タスク管理
```

### 2. PreToolUse Hook (実行承認)

**設定 (.claude/settings.json)**
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash|Write|Edit",
        "hooks": [{
          "type": "command",
          "command": "python3 $CLAUDE_PROJECT_DIR/.claude/hooks/slack-approval.py",
          "timeout": 320000
        }]
      }
    ]
  }
}
```

**承認フロー**
```
コマンド実行 → Hook起動 → Slack通知 → ボタン待機 → JSON出力
                                                      │
                         ┌────────────────────────────┴────────┐
                         ▼                                     ▼
              permissionDecision: "allow"         permissionDecision: "deny"
                    実行継続                              ブロック
```

### 3. MCP: ask-human (質問機能)

```
mcp-servers/
└── ask-human/
    └── src/
        └── index.ts      # MCPサーバー実装
```

**使用例**
```
sumomo: 「認証方式をJWTにしますか？セッションにしますか？」
         ↓
Slack: [JWT] [セッション] [両方サポート]
         ↓
ユーザー: [JWT] をクリック
         ↓
sumomo: JWTで実装を継続
```

---

## 処理フロー

### GitHub Issue 対応フロー

```
1. GitHub Issue 作成
   └─ 本文に @sumomo を含む

2. sumomo Bot が検知 (5分間隔ポーリング)

3. Slack に通知
   └─ 「🍑 Issue #42 の対応を開始します」

4. Claude CLI 起動
   └─ Issue内容をプロンプトとして渡す

5. Claude がコード分析・修正
   │
   ├─ 危険なコマンド実行時
   │   └─ PreToolUse Hook → Slack承認待ち
   │
   └─ 判断が必要な時
       └─ ask-human MCP → Slackで質問

6. PR作成
   └─ git push & gh pr create

7. 完了通知
   ├─ Slack: 「🍑 PR作成しました: https://...」
   └─ GitHub Issue: コメント追加
```

### Slack 指示フロー

```
1. Slack で @sumomo メンション
   └─ 「LoginService.cs のバグを直して」

2. スレッドで処理開始通知
   └─ 「🍑 処理を開始します...」

3. Claude CLI 実行
   └─ (承認・質問は同様)

4. スレッドで結果報告
   └─ 「🍑 完了しました。変更内容: ...」
```

---

## 承認が必要な操作

| ツール | パターン | 理由 |
|--------|---------|------|
| Bash | `git push` | リモートへの変更 |
| Bash | `git commit` | 履歴の変更 |
| Bash | `rm ` | ファイル削除 |
| Bash | `npm publish` | パッケージ公開 |
| Write | すべて | ファイル作成 |
| Edit | すべて | ファイル編集 |

※ 設定でカスタマイズ可能

---

## 必要な認証情報

| 項目 | 用途 | 取得方法 |
|------|------|---------|
| `ANTHROPIC_API_KEY` | Claude API | Anthropic Console |
| `SLACK_BOT_TOKEN` | Slack API | Slack App設定 (xoxb-...) |
| `SLACK_APP_TOKEN` | Socket Mode | Slack App設定 (xapp-...) |
| `GITHUB_TOKEN` | GitHub API | GitHub Settings > Developer settings |

---

## Slack App 設定

| 項目 | 設定値 |
|------|--------|
| App Name | sumomo |
| Socket Mode | ON |
| Event Subscriptions | `app_mention`, `message.channels` |
| Interactivity | ON |
| Bot Token Scopes | `app_mentions:read`, `chat:write`, `channels:history` |

---

## 拡張: Jenkins Agent 分散 (オプション)

複数PCで並列処理したい場合：

```
┌─────────────────────────────────────────────────────────────────┐
│  Jenkins Master                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  sumomo Bot (GitHub監視 + Slack)                         │    │
│  │  ↓ タスク発生                                           │    │
│  │  process-issue ジョブを非同期で起動                      │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                    │
      ┌─────────────┼─────────────┐
      ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Agent A  │  │ Agent B  │  │ Agent C  │
│ (PC-A)   │  │ (PC-B)   │  │ (PC-C)   │
│ Unity環境 │  │ Unity環境 │  │ Unity環境 │
└──────────┘  └──────────┘  └──────────┘
```

---

## ディレクトリ構成

```
sumomo/
├── docs/
│   └── DESIGN.md              # 本設計書
├── src/                       # 統合Botソース
│   ├── index.ts
│   ├── slack/
│   ├── github/
│   ├── approval/
│   ├── claude/
│   └── queue/
├── mcp-servers/
│   └── ask-human/             # 質問MCP
├── .claude/
│   ├── settings.json          # Hook設定
│   └── hooks/
│       └── slack-approval.py  # 承認スクリプト
├── package.json
├── tsconfig.json
└── README.md
```

---

## 起動方法

```bash
# 1. 依存インストール
npm install

# 2. 環境変数設定
export ANTHROPIC_API_KEY="sk-..."
export SLACK_BOT_TOKEN="xoxb-..."
export SLACK_APP_TOKEN="xapp-..."
export GITHUB_TOKEN="ghp_..."
export SLACK_CHANNEL_ID="#sumomo-notifications"

# 3. 起動
npm start

# または常駐化 (macOS)
launchctl load ~/Library/LaunchAgents/com.sumomo.plist
```

---

## Slack表示イメージ

### 通常の指示

```
┌─────────────────────────────────────────────────────────────┐
│ #development                                                │
├─────────────────────────────────────────────────────────────┤
│ 佐藤: @sumomo このIssueを対応して                           │
│       https://github.com/our-org/app/issues/42              │
│                                                             │
│ └─ sumomo: 🍑 処理を開始します...                           │
│    └─ sumomo: 🍑 完了しました                               │
│       PRを作成しました: https://github.com/.../pull/123     │
└─────────────────────────────────────────────────────────────┘
```

### 承認リクエスト

```
┌─────────────────────────────────────────────────────────────┐
│ 🍑 sumomo 実行許可リクエスト                                │
│                                                             │
│ ツール: Bash                    Issue: #42                  │
│                                                             │
│ 詳細:                                                       │
│ コマンド: `git push origin fix/issue-42`                    │
│                                                             │
│ [✅ 許可]  [❌ 拒否]  [👀 詳細確認]                          │
└─────────────────────────────────────────────────────────────┘
```

### 質問

```
┌─────────────────────────────────────────────────────────────┐
│ 🍑 sumomo からの質問                                        │
│ Issue: #42 ログイン機能の修正                               │
│                                                             │
│ 認証方式について確認させてください。                        │
│ 現在JWT認証を使用していますが、セッション認証に             │
│ 変更しますか？                                              │
│                                                             │
│ [JWT維持] [セッションに変更] [両方サポート]                 │
└─────────────────────────────────────────────────────────────┘
```
